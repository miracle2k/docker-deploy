# This installs some base images that are required on the host, notably
# etcd and discoverd. Later, flynn-host bootstrapping may take care of
# this instead.
#
# These services are special in that they provide service discovery itself,
# so they can't rely on it themselves.
#
# While discoverd needs etcd, the bigger challenge is that everything
# needs discoverd.
#
# There are only two options: DNS or host mapped ports, and DNS is harder
# to do and has the caching issue.


coreos/etcd:
  # It seems due to the stange way etcdctl connects, we need to set --peer-addr
  cmd: -name {HOST} -data-dir /data.etcd -bind-addr=0.0.0.0:{PORT} --peer-addr={HOST}:7001
  volumes: {data: /data.etcd}
  host_ports: {"": 4001}


flynn/discoverd:
  wait: http://{HOST}:4001
  cmd: -etcd http://{HOST}:4001
  env:
    EXTERNAL_IP: "{HOST}"
  ports: {rpc: 1111}
  host_ports: {rpc: 1111}


elsdoerfer/shelf:
  wait: tcp://{HOST}:1001
  cmd: -s /var/lib/shelf
  volumes: {data: /var/lib/shelf}


elsdoerfer/strowger:
  wait: tcp://{HOST}:1001
  cmd: -httpaddr=":{PORT_HTTP}" --httpsaddr=":{PORT_HTTPS}" --apiaddr=":{PORT_RPC}"
  ports: [http, https, rpc]
  host_ports: {http: "0.0.0.0:80", https: "0.0.0.0:443"}

